import { __assign, __decorate, __param, __read } from "tslib";
import { ComponentFactoryResolver, ComponentRef, Directive, ElementRef, Inject, Input, OnDestroy, OnInit, Optional, Self, TemplateRef, ViewContainerRef, EmbeddedViewRef } from '@angular/core';
import { AbstractControl, ControlContainer, NgControl, ValidationErrors } from '@angular/forms';
import { DefaultControlErrorComponent } from './control-error.component';
import { ControlErrorAnchorDirective } from './control-error-anchor.directive';
import { EMPTY, fromEvent, merge, NEVER, Subject } from 'rxjs';
import { ErrorTailorConfigProvider, FORM_ERRORS } from './providers';
import { distinctUntilChanged, mapTo, startWith, switchMap, takeUntil } from 'rxjs/operators';
import { FormActionDirective } from './form-action.directive';
var ControlErrorsDirective = /** @class */ (function () {
    function ControlErrorsDirective(vcr, resolver, host, config, globalErrors, controlErrorAnchorParent, form, ngControl, controlContainer) {
        this.vcr = vcr;
        this.resolver = resolver;
        this.host = host;
        this.config = config;
        this.globalErrors = globalErrors;
        this.controlErrorAnchorParent = controlErrorAnchorParent;
        this.form = form;
        this.ngControl = ngControl;
        this.controlContainer = controlContainer;
        this.customErrors = {};
        this.controlErrorsOnAsync = true;
        this.controlErrorsOnBlur = true;
        this.destroy = new Subject();
        this.mergedConfig = {};
        this.submit$ = this.form ? this.form.submit$ : EMPTY;
        this.reset$ = this.form ? this.form.reset$ : EMPTY;
        this.mergedConfig = this.buildConfig();
    }
    ControlErrorsDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.anchor = this.resolveAnchor();
        this.control = (this.controlContainer || this.ngControl).control;
        var hasAsyncValidator = !!this.control.asyncValidator;
        var isInput = this.mergedConfig.blurPredicate(this.host.nativeElement);
        var statusChanges$ = this.control.statusChanges.pipe(distinctUntilChanged());
        var valueChanges$ = this.control.valueChanges;
        var controlChanges$ = merge(statusChanges$, valueChanges$);
        var changesOnAsync$ = EMPTY;
        var changesOnBlur$ = EMPTY;
        if (this.controlErrorsOnAsync && hasAsyncValidator) {
            // hasAsyncThenUponStatusChange
            changesOnAsync$ = statusChanges$.pipe(startWith(true));
        }
        if (this.controlErrorsOnBlur && isInput) {
            var blur$ = fromEvent(this.host.nativeElement, 'focusout');
            // blurFirstThenUponChange
            changesOnBlur$ = blur$.pipe(switchMap(function () { return valueChanges$.pipe(startWith(true)); }));
        }
        var submit$ = merge(this.submit$.pipe(mapTo(true)), this.reset$.pipe(mapTo(false)));
        // when submitted, submitFirstThenUponChanges
        var changesOnSubmit$ = submit$.pipe(switchMap(function (submit) { return (submit ? controlChanges$.pipe(startWith(true)) : NEVER); }));
        // on reset, clear ComponentRef and customAnchorDestroyFn
        this.reset$.pipe(takeUntil(this.destroy)).subscribe(function () { return _this.clearRefs(); });
        merge(changesOnAsync$, changesOnBlur$, changesOnSubmit$)
            .pipe(takeUntil(this.destroy))
            .subscribe(function () { return _this.valueChanges(); });
    };
    ControlErrorsDirective.prototype.setError = function (text, error) {
        if (!this.ref) {
            var factory = this.resolver.resolveComponentFactory(this.mergedConfig.controlErrorComponent);
            this.ref = this.anchor.createComponent(factory);
        }
        var instance = this.ref.instance;
        if (this.controlErrorsTpl) {
            instance.createTemplate(this.controlErrorsTpl, error, text);
        }
        else {
            instance.text = text;
        }
        if (this.controlErrorsClass) {
            instance.customClass = this.controlErrorsClass;
        }
        if (this.mergedConfig.controlErrorComponentAnchorFn) {
            this.customAnchorDestroyFn = this.mergedConfig.controlErrorComponentAnchorFn(this.host.nativeElement, this.ref.hostView.rootNodes[0]);
        }
    };
    ControlErrorsDirective.prototype.ngOnDestroy = function () {
        this.destroy.next();
        this.clearRefs();
    };
    ControlErrorsDirective.prototype.clearRefs = function () {
        if (this.customAnchorDestroyFn) {
            this.customAnchorDestroyFn();
            this.customAnchorDestroyFn = null;
        }
        if (this.ref) {
            this.ref.destroy();
        }
        this.ref = null;
    };
    ControlErrorsDirective.prototype.valueChanges = function () {
        var controlErrors = this.control.errors;
        if (controlErrors) {
            var _a = __read(Object.keys(controlErrors), 1), firstKey = _a[0];
            var getError = this.customErrors[firstKey] || this.globalErrors[firstKey];
            if (!getError) {
                return;
            }
            var text = typeof getError === 'function' ? getError(controlErrors[firstKey]) : getError;
            this.setError(text, controlErrors);
        }
        else if (this.ref) {
            this.setError(null);
        }
    };
    ControlErrorsDirective.prototype.resolveAnchor = function () {
        if (this.controlErrorAnchor) {
            return this.controlErrorAnchor.vcr;
        }
        if (this.controlErrorAnchorParent) {
            return this.controlErrorAnchorParent.vcr;
        }
        return this.vcr;
    };
    ControlErrorsDirective.prototype.buildConfig = function () {
        return __assign({
            blurPredicate: function (element) {
                return element.tagName === 'INPUT' || element.tagName === 'SELECT';
            },
            controlErrorComponent: DefaultControlErrorComponent
        }, this.config);
    };
    ControlErrorsDirective.ctorParameters = function () { return [
        { type: ViewContainerRef },
        { type: ComponentFactoryResolver },
        { type: ElementRef },
        { type: undefined, decorators: [{ type: Inject, args: [ErrorTailorConfigProvider,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [FORM_ERRORS,] }] },
        { type: ControlErrorAnchorDirective, decorators: [{ type: Optional }] },
        { type: FormActionDirective, decorators: [{ type: Optional }] },
        { type: NgControl, decorators: [{ type: Optional }, { type: Self }] },
        { type: ControlContainer, decorators: [{ type: Optional }, { type: Self }] }
    ]; };
    __decorate([
        Input('controlErrors')
    ], ControlErrorsDirective.prototype, "customErrors", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorsClass", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorsTpl", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorsOnAsync", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorsOnBlur", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorAnchor", void 0);
    ControlErrorsDirective = __decorate([
        Directive({
            selector: '[formControlName]:not([controlErrorsIgnore]), [formControl]:not([controlErrorsIgnore]), [formGroup]:not([controlErrorsIgnore]), [formGroupName]:not([controlErrorsIgnore]), [formArrayName]:not([controlErrorsIgnore]), [ngModel]:not([controlErrorsIgnore])'
        }),
        __param(3, Inject(ErrorTailorConfigProvider)),
        __param(4, Inject(FORM_ERRORS)),
        __param(5, Optional()),
        __param(6, Optional()),
        __param(7, Optional()), __param(7, Self()),
        __param(8, Optional()), __param(8, Self())
    ], ControlErrorsDirective);
    return ControlErrorsDirective;
}());
export { ControlErrorsDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbC1lcnJvci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbmduZWF0L2Vycm9yLXRhaWxvci8iLCJzb3VyY2VzIjpbImxpYi9jb250cm9sLWVycm9yLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLHdCQUF3QixFQUN4QixZQUFZLEVBQ1osU0FBUyxFQUNULFVBQVUsRUFDVixNQUFNLEVBQ04sS0FBSyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sUUFBUSxFQUNSLElBQUksRUFDSixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2hCLGVBQWUsRUFDaEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRyxPQUFPLEVBQUUsNEJBQTRCLEVBQXlCLE1BQU0sMkJBQTJCLENBQUM7QUFDaEcsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDL0UsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0UsT0FBTyxFQUFxQix5QkFBeUIsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEYsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBTyxNQUFNLGdCQUFnQixDQUFDO0FBQ25HLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBTzlEO0lBaUJFLGdDQUNVLEdBQXFCLEVBQ3JCLFFBQWtDLEVBQ2xDLElBQWdCLEVBQ21CLE1BQXlCLEVBQ3ZDLFlBQVksRUFDckIsd0JBQXFELEVBQ3JELElBQXlCLEVBQ2pCLFNBQW9CLEVBQ3BCLGdCQUFrQztRQVJ0RCxRQUFHLEdBQUgsR0FB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LFlBQUksSUFBSTtnQkFDNkIsZ0JBQWdCLHVCQUE3RCxRQUFRLFlBQUksSUFBSTs7SUF6Qks7UUFBdkIsS0FBSyxDQUFDLGVBQWUsQ0FBQztnRUFBOEI7SUFDNUM7UUFBUixLQUFLLEVBQUU7c0VBQXdDO0lBQ3ZDO1FBQVIsS0FBSyxFQUFFO29FQUFnRDtJQUMvQztRQUFSLEtBQUssRUFBRTt3RUFBNkI7SUFDNUI7UUFBUixLQUFLLEVBQUU7dUVBQTRCO0lBQzNCO1FBQVIsS0FBSyxFQUFFO3NFQUFpRDtJQU45QyxzQkFBc0I7UUFKbEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUNOLDhQQUE4UDtTQUNqUSxDQUFDO1FBc0JHLFdBQUEsTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUE7UUFDakMsV0FBQSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUE7UUFDbkIsV0FBQSxRQUFRLEVBQUUsQ0FBQTtRQUNWLFdBQUEsUUFBUSxFQUFFLENBQUE7UUFDVixXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxJQUFJLEVBQUUsQ0FBQTtRQUNsQixXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxJQUFJLEVBQUUsQ0FBQTtPQTFCVixzQkFBc0IsQ0F3SmxDO0lBQUQsNkJBQUM7Q0FBQSxBQXhKRCxJQXdKQztTQXhKWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIENvbXBvbmVudFJlZixcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBJbmplY3QsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3B0aW9uYWwsXG4gIFNlbGYsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBFbWJlZGRlZFZpZXdSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIENvbnRyb2xDb250YWluZXIsIE5nQ29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IERlZmF1bHRDb250cm9sRXJyb3JDb21wb25lbnQsIENvbnRyb2xFcnJvckNvbXBvbmVudCB9IGZyb20gJy4vY29udHJvbC1lcnJvci5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ29udHJvbEVycm9yQW5jaG9yRGlyZWN0aXZlIH0gZnJvbSAnLi9jb250cm9sLWVycm9yLWFuY2hvci5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgRU1QVFksIGZyb21FdmVudCwgbWVyZ2UsIE5FVkVSLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBFcnJvclRhaWxvckNvbmZpZywgRXJyb3JUYWlsb3JDb25maWdQcm92aWRlciwgRk9STV9FUlJPUlMgfSBmcm9tICcuL3Byb3ZpZGVycyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwVG8sIHN0YXJ0V2l0aCwgc3dpdGNoTWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZvcm1BY3Rpb25EaXJlY3RpdmUgfSBmcm9tICcuL2Zvcm0tYWN0aW9uLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBFcnJvcnNNYXAgfSBmcm9tICcuL3R5cGVzJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOlxuICAgICdbZm9ybUNvbnRyb2xOYW1lXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1Db250cm9sXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1Hcm91cF06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSksIFtmb3JtR3JvdXBOYW1lXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1BcnJheU5hbWVdOm5vdChbY29udHJvbEVycm9yc0lnbm9yZV0pLCBbbmdNb2RlbF06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSknXG59KVxuZXhwb3J0IGNsYXNzIENvbnRyb2xFcnJvcnNEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgnY29udHJvbEVycm9ycycpIGN1c3RvbUVycm9yczogRXJyb3JzTWFwID0ge307XG4gIEBJbnB1dCgpIGNvbnRyb2xFcnJvcnNDbGFzczogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBASW5wdXQoKSBjb250cm9sRXJyb3JzVHBsOiBUZW1wbGF0ZVJlZjxhbnk+IHwgdW5kZWZpbmVkO1xuICBASW5wdXQoKSBjb250cm9sRXJyb3JzT25Bc3luYyA9IHRydWU7XG4gIEBJbnB1dCgpIGNvbnRyb2xFcnJvcnNPbkJsdXIgPSB0cnVlO1xuICBASW5wdXQoKSBjb250cm9sRXJyb3JBbmNob3I6IENvbnRyb2xFcnJvckFuY2hvckRpcmVjdGl2ZTtcblxuICBwcml2YXRlIHJlZjogQ29tcG9uZW50UmVmPENvbnRyb2xFcnJvckNvbXBvbmVudD47XG4gIHByaXZhdGUgYW5jaG9yOiBWaWV3Q29udGFpbmVyUmVmO1xuICBwcml2YXRlIHN1Ym1pdCQ6IE9ic2VydmFibGU8RXZlbnQ+O1xuICBwcml2YXRlIHJlc2V0JDogT2JzZXJ2YWJsZTxFdmVudD47XG4gIHByaXZhdGUgY29udHJvbDogQWJzdHJhY3RDb250cm9sO1xuICBwcml2YXRlIGRlc3Ryb3kgPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIG1lcmdlZENvbmZpZzogRXJyb3JUYWlsb3JDb25maWcgPSB7fTtcbiAgcHJpdmF0ZSBjdXN0b21BbmNob3JEZXN0cm95Rm46ICgpID0+IHZvaWQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB2Y3I6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgaG9zdDogRWxlbWVudFJlZixcbiAgICBASW5qZWN0KEVycm9yVGFpbG9yQ29uZmlnUHJvdmlkZXIpIHByaXZhdGUgY29uZmlnOiBFcnJvclRhaWxvckNvbmZpZyxcbiAgICBASW5qZWN0KEZPUk1fRVJST1JTKSBwcml2YXRlIGdsb2JhbEVycm9ycyxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGNvbnRyb2xFcnJvckFuY2hvclBhcmVudDogQ29udHJvbEVycm9yQW5jaG9yRGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZm9ybTogRm9ybUFjdGlvbkRpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKSBAU2VsZigpIHByaXZhdGUgbmdDb250cm9sOiBOZ0NvbnRyb2wsXG4gICAgQE9wdGlvbmFsKCkgQFNlbGYoKSBwcml2YXRlIGNvbnRyb2xDb250YWluZXI6IENvbnRyb2xDb250YWluZXJcbiAgKSB7XG4gICAgdGhpcy5zdWJtaXQkID0gdGhpcy5mb3JtID8gdGhpcy5mb3JtLnN1Ym1pdCQgOiBFTVBUWTtcbiAgICB0aGlzLnJlc2V0JCA9IHRoaXMuZm9ybSA/IHRoaXMuZm9ybS5yZXNldCQgOiBFTVBUWTtcbiAgICB0aGlzLm1lcmdlZENvbmZpZyA9IHRoaXMuYnVpbGRDb25maWcoKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuYW5jaG9yID0gdGhpcy5yZXNvbHZlQW5jaG9yKCk7XG4gICAgdGhpcy5jb250cm9sID0gKHRoaXMuY29udHJvbENvbnRhaW5lciB8fCB0aGlzLm5nQ29udHJvbCkuY29udHJvbDtcbiAgICBjb25zdCBoYXNBc3luY1ZhbGlkYXRvciA9ICEhdGhpcy5jb250cm9sLmFzeW5jVmFsaWRhdG9yO1xuICAgIGNvbnN0IGlzSW5wdXQgPSB0aGlzLm1lcmdlZENvbmZpZy5ibHVyUHJlZGljYXRlKHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50KTtcblxuICAgIGNvbnN0IHN0YXR1c0NoYW5nZXMkID0gdGhpcy5jb250cm9sLnN0YXR1c0NoYW5nZXMucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcbiAgICBjb25zdCB2YWx1ZUNoYW5nZXMkID0gdGhpcy5jb250cm9sLnZhbHVlQ2hhbmdlcztcbiAgICBjb25zdCBjb250cm9sQ2hhbmdlcyQgPSBtZXJnZShzdGF0dXNDaGFuZ2VzJCwgdmFsdWVDaGFuZ2VzJCk7XG4gICAgbGV0IGNoYW5nZXNPbkFzeW5jJDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XG4gICAgbGV0IGNoYW5nZXNPbkJsdXIkOiBPYnNlcnZhYmxlPGFueT4gPSBFTVBUWTtcblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvcnNPbkFzeW5jICYmIGhhc0FzeW5jVmFsaWRhdG9yKSB7XG4gICAgICAvLyBoYXNBc3luY1RoZW5VcG9uU3RhdHVzQ2hhbmdlXG4gICAgICBjaGFuZ2VzT25Bc3luYyQgPSBzdGF0dXNDaGFuZ2VzJC5waXBlKHN0YXJ0V2l0aCh0cnVlKSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yc09uQmx1ciAmJiBpc0lucHV0KSB7XG4gICAgICBjb25zdCBibHVyJCA9IGZyb21FdmVudCh0aGlzLmhvc3QubmF0aXZlRWxlbWVudCwgJ2ZvY3Vzb3V0Jyk7XG4gICAgICAvLyBibHVyRmlyc3RUaGVuVXBvbkNoYW5nZVxuICAgICAgY2hhbmdlc09uQmx1ciQgPSBibHVyJC5waXBlKHN3aXRjaE1hcCgoKSA9PiB2YWx1ZUNoYW5nZXMkLnBpcGUoc3RhcnRXaXRoKHRydWUpKSkpO1xuICAgIH1cblxuICAgIGNvbnN0IHN1Ym1pdCQgPSBtZXJnZSh0aGlzLnN1Ym1pdCQucGlwZShtYXBUbyh0cnVlKSksIHRoaXMucmVzZXQkLnBpcGUobWFwVG8oZmFsc2UpKSk7XG5cbiAgICAvLyB3aGVuIHN1Ym1pdHRlZCwgc3VibWl0Rmlyc3RUaGVuVXBvbkNoYW5nZXNcbiAgICBjb25zdCBjaGFuZ2VzT25TdWJtaXQkID0gc3VibWl0JC5waXBlKFxuICAgICAgc3dpdGNoTWFwKHN1Ym1pdCA9PiAoc3VibWl0ID8gY29udHJvbENoYW5nZXMkLnBpcGUoc3RhcnRXaXRoKHRydWUpKSA6IE5FVkVSKSlcbiAgICApO1xuXG4gICAgLy8gb24gcmVzZXQsIGNsZWFyIENvbXBvbmVudFJlZiBhbmQgY3VzdG9tQW5jaG9yRGVzdHJveUZuXG4gICAgdGhpcy5yZXNldCQucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95KSkuc3Vic2NyaWJlKCgpID0+IHRoaXMuY2xlYXJSZWZzKCkpO1xuXG4gICAgbWVyZ2UoY2hhbmdlc09uQXN5bmMkLCBjaGFuZ2VzT25CbHVyJCwgY2hhbmdlc09uU3VibWl0JClcbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnZhbHVlQ2hhbmdlcygpKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0RXJyb3IodGV4dDogc3RyaW5nLCBlcnJvcj86IFZhbGlkYXRpb25FcnJvcnMpIHtcbiAgICBpZiAoIXRoaXMucmVmKSB7XG4gICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeTxDb250cm9sRXJyb3JDb21wb25lbnQ+KFxuICAgICAgICB0aGlzLm1lcmdlZENvbmZpZy5jb250cm9sRXJyb3JDb21wb25lbnRcbiAgICAgICk7XG4gICAgICB0aGlzLnJlZiA9IHRoaXMuYW5jaG9yLmNyZWF0ZUNvbXBvbmVudDxDb250cm9sRXJyb3JDb21wb25lbnQ+KGZhY3RvcnkpO1xuICAgIH1cbiAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMucmVmLmluc3RhbmNlO1xuXG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yc1RwbCkge1xuICAgICAgaW5zdGFuY2UuY3JlYXRlVGVtcGxhdGUodGhpcy5jb250cm9sRXJyb3JzVHBsLCBlcnJvciwgdGV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluc3RhbmNlLnRleHQgPSB0ZXh0O1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcykge1xuICAgICAgaW5zdGFuY2UuY3VzdG9tQ2xhc3MgPSB0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcztcbiAgICB9XG5cbiAgICBpZiAodGhpcy5tZXJnZWRDb25maWcuY29udHJvbEVycm9yQ29tcG9uZW50QW5jaG9yRm4pIHtcbiAgICAgIHRoaXMuY3VzdG9tQW5jaG9yRGVzdHJveUZuID0gdGhpcy5tZXJnZWRDb25maWcuY29udHJvbEVycm9yQ29tcG9uZW50QW5jaG9yRm4oXG4gICAgICAgIHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50IGFzIEhUTUxFbGVtZW50LFxuICAgICAgICAodGhpcy5yZWYuaG9zdFZpZXcgYXMgRW1iZWRkZWRWaWV3UmVmPGFueT4pLnJvb3ROb2Rlc1swXSBhcyBIVE1MRWxlbWVudFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3kubmV4dCgpO1xuICAgIHRoaXMuY2xlYXJSZWZzKCk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFyUmVmcygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jdXN0b21BbmNob3JEZXN0cm95Rm4pIHtcbiAgICAgIHRoaXMuY3VzdG9tQW5jaG9yRGVzdHJveUZuKCk7XG4gICAgICB0aGlzLmN1c3RvbUFuY2hvckRlc3Ryb3lGbiA9IG51bGw7XG4gICAgfVxuICAgIGlmICh0aGlzLnJlZikge1xuICAgICAgdGhpcy5yZWYuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLnJlZiA9IG51bGw7XG4gIH1cblxuICBwcml2YXRlIHZhbHVlQ2hhbmdlcygpIHtcbiAgICBjb25zdCBjb250cm9sRXJyb3JzID0gdGhpcy5jb250cm9sLmVycm9ycztcbiAgICBpZiAoY29udHJvbEVycm9ycykge1xuICAgICAgY29uc3QgW2ZpcnN0S2V5XSA9IE9iamVjdC5rZXlzKGNvbnRyb2xFcnJvcnMpO1xuICAgICAgY29uc3QgZ2V0RXJyb3IgPSB0aGlzLmN1c3RvbUVycm9yc1tmaXJzdEtleV0gfHwgdGhpcy5nbG9iYWxFcnJvcnNbZmlyc3RLZXldO1xuICAgICAgaWYgKCFnZXRFcnJvcikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRleHQgPSB0eXBlb2YgZ2V0RXJyb3IgPT09ICdmdW5jdGlvbicgPyBnZXRFcnJvcihjb250cm9sRXJyb3JzW2ZpcnN0S2V5XSkgOiBnZXRFcnJvcjtcbiAgICAgIHRoaXMuc2V0RXJyb3IodGV4dCwgY29udHJvbEVycm9ycyk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnJlZikge1xuICAgICAgdGhpcy5zZXRFcnJvcihudWxsKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlc29sdmVBbmNob3IoKSB7XG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yQW5jaG9yKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb250cm9sRXJyb3JBbmNob3IudmNyO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvckFuY2hvclBhcmVudCkge1xuICAgICAgcmV0dXJuIHRoaXMuY29udHJvbEVycm9yQW5jaG9yUGFyZW50LnZjcjtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmNyO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENvbmZpZygpOiBFcnJvclRhaWxvckNvbmZpZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLntcbiAgICAgICAgYmx1clByZWRpY2F0ZShlbGVtZW50KSB7XG4gICAgICAgICAgcmV0dXJuIGVsZW1lbnQudGFnTmFtZSA9PT0gJ0lOUFVUJyB8fCBlbGVtZW50LnRhZ05hbWUgPT09ICdTRUxFQ1QnO1xuICAgICAgICB9LFxuICAgICAgICBjb250cm9sRXJyb3JDb21wb25lbnQ6IERlZmF1bHRDb250cm9sRXJyb3JDb21wb25lbnRcbiAgICAgIH0sXG4gICAgICAuLi50aGlzLmNvbmZpZ1xuICAgIH07XG4gIH1cbn1cbiJdfQ==