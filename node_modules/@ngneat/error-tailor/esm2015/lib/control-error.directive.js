import { __decorate, __param } from "tslib";
import { ComponentFactoryResolver, ComponentRef, Directive, ElementRef, Inject, Input, OnDestroy, OnInit, Optional, Self, TemplateRef, ViewContainerRef, EmbeddedViewRef } from '@angular/core';
import { AbstractControl, ControlContainer, NgControl, ValidationErrors } from '@angular/forms';
import { DefaultControlErrorComponent } from './control-error.component';
import { ControlErrorAnchorDirective } from './control-error-anchor.directive';
import { EMPTY, fromEvent, merge, NEVER, Subject } from 'rxjs';
import { ErrorTailorConfigProvider, FORM_ERRORS } from './providers';
import { distinctUntilChanged, mapTo, startWith, switchMap, takeUntil } from 'rxjs/operators';
import { FormActionDirective } from './form-action.directive';
let ControlErrorsDirective = class ControlErrorsDirective {
    constructor(vcr, resolver, host, config, globalErrors, controlErrorAnchorParent, form, ngControl, controlContainer) {
        this.vcr = vcr;
        this.resolver = resolver;
        this.host = host;
        this.config = config;
        this.globalErrors = globalErrors;
        this.controlErrorAnchorParent = controlErrorAnchorParent;
        this.form = form;
        this.ngControl = ngControl;
        this.controlContainer = controlContainer;
        this.customErrors = {};
        this.controlErrorsOnAsync = true;
        this.controlErrorsOnBlur = true;
        this.destroy = new Subject();
        this.mergedConfig = {};
        this.submit$ = this.form ? this.form.submit$ : EMPTY;
        this.reset$ = this.form ? this.form.reset$ : EMPTY;
        this.mergedConfig = this.buildConfig();
    }
    ngOnInit() {
        this.anchor = this.resolveAnchor();
        this.control = (this.controlContainer || this.ngControl).control;
        const hasAsyncValidator = !!this.control.asyncValidator;
        const isInput = this.mergedConfig.blurPredicate(this.host.nativeElement);
        const statusChanges$ = this.control.statusChanges.pipe(distinctUntilChanged());
        const valueChanges$ = this.control.valueChanges;
        const controlChanges$ = merge(statusChanges$, valueChanges$);
        let changesOnAsync$ = EMPTY;
        let changesOnBlur$ = EMPTY;
        if (this.controlErrorsOnAsync && hasAsyncValidator) {
            // hasAsyncThenUponStatusChange
            changesOnAsync$ = statusChanges$.pipe(startWith(true));
        }
        if (this.controlErrorsOnBlur && isInput) {
            const blur$ = fromEvent(this.host.nativeElement, 'focusout');
            // blurFirstThenUponChange
            changesOnBlur$ = blur$.pipe(switchMap(() => valueChanges$.pipe(startWith(true))));
        }
        const submit$ = merge(this.submit$.pipe(mapTo(true)), this.reset$.pipe(mapTo(false)));
        // when submitted, submitFirstThenUponChanges
        const changesOnSubmit$ = submit$.pipe(switchMap(submit => (submit ? controlChanges$.pipe(startWith(true)) : NEVER)));
        // on reset, clear ComponentRef and customAnchorDestroyFn
        this.reset$.pipe(takeUntil(this.destroy)).subscribe(() => this.clearRefs());
        merge(changesOnAsync$, changesOnBlur$, changesOnSubmit$)
            .pipe(takeUntil(this.destroy))
            .subscribe(() => this.valueChanges());
    }
    setError(text, error) {
        if (!this.ref) {
            const factory = this.resolver.resolveComponentFactory(this.mergedConfig.controlErrorComponent);
            this.ref = this.anchor.createComponent(factory);
        }
        const instance = this.ref.instance;
        if (this.controlErrorsTpl) {
            instance.createTemplate(this.controlErrorsTpl, error, text);
        }
        else {
            instance.text = text;
        }
        if (this.controlErrorsClass) {
            instance.customClass = this.controlErrorsClass;
        }
        if (this.mergedConfig.controlErrorComponentAnchorFn) {
            this.customAnchorDestroyFn = this.mergedConfig.controlErrorComponentAnchorFn(this.host.nativeElement, this.ref.hostView.rootNodes[0]);
        }
    }
    ngOnDestroy() {
        this.destroy.next();
        this.clearRefs();
    }
    clearRefs() {
        if (this.customAnchorDestroyFn) {
            this.customAnchorDestroyFn();
            this.customAnchorDestroyFn = null;
        }
        if (this.ref) {
            this.ref.destroy();
        }
        this.ref = null;
    }
    valueChanges() {
        const controlErrors = this.control.errors;
        if (controlErrors) {
            const [firstKey] = Object.keys(controlErrors);
            const getError = this.customErrors[firstKey] || this.globalErrors[firstKey];
            if (!getError) {
                return;
            }
            const text = typeof getError === 'function' ? getError(controlErrors[firstKey]) : getError;
            this.setError(text, controlErrors);
        }
        else if (this.ref) {
            this.setError(null);
        }
    }
    resolveAnchor() {
        if (this.controlErrorAnchor) {
            return this.controlErrorAnchor.vcr;
        }
        if (this.controlErrorAnchorParent) {
            return this.controlErrorAnchorParent.vcr;
        }
        return this.vcr;
    }
    buildConfig() {
        return Object.assign({
            blurPredicate(element) {
                return element.tagName === 'INPUT' || element.tagName === 'SELECT';
            },
            controlErrorComponent: DefaultControlErrorComponent
        }, this.config);
    }
};
ControlErrorsDirective.ctorParameters = () => [
    { type: ViewContainerRef },
    { type: ComponentFactoryResolver },
    { type: ElementRef },
    { type: undefined, decorators: [{ type: Inject, args: [ErrorTailorConfigProvider,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [FORM_ERRORS,] }] },
    { type: ControlErrorAnchorDirective, decorators: [{ type: Optional }] },
    { type: FormActionDirective, decorators: [{ type: Optional }] },
    { type: NgControl, decorators: [{ type: Optional }, { type: Self }] },
    { type: ControlContainer, decorators: [{ type: Optional }, { type: Self }] }
];
__decorate([
    Input('controlErrors')
], ControlErrorsDirective.prototype, "customErrors", void 0);
__decorate([
    Input()
], ControlErrorsDirective.prototype, "controlErrorsClass", void 0);
__decorate([
    Input()
], ControlErrorsDirective.prototype, "controlErrorsTpl", void 0);
__decorate([
    Input()
], ControlErrorsDirective.prototype, "controlErrorsOnAsync", void 0);
__decorate([
    Input()
], ControlErrorsDirective.prototype, "controlErrorsOnBlur", void 0);
__decorate([
    Input()
], ControlErrorsDirective.prototype, "controlErrorAnchor", void 0);
ControlErrorsDirective = __decorate([
    Directive({
        selector: '[formControlName]:not([controlErrorsIgnore]), [formControl]:not([controlErrorsIgnore]), [formGroup]:not([controlErrorsIgnore]), [formGroupName]:not([controlErrorsIgnore]), [formArrayName]:not([controlErrorsIgnore]), [ngModel]:not([controlErrorsIgnore])'
    }),
    __param(3, Inject(ErrorTailorConfigProvider)),
    __param(4, Inject(FORM_ERRORS)),
    __param(5, Optional()),
    __param(6, Optional()),
    __param(7, Optional()), __param(7, Self()),
    __param(8, Optional()), __param(8, Self())
], ControlErrorsDirective);
export { ControlErrorsDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbC1lcnJvci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbmduZWF0L2Vycm9yLXRhaWxvci8iLCJzb3VyY2VzIjpbImxpYi9jb250cm9sLWVycm9yLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLHdCQUF3QixFQUN4QixZQUFZLEVBQ1osU0FBUyxFQUNULFVBQVUsRUFDVixNQUFNLEVBQ04sS0FBSyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sUUFBUSxFQUNSLElBQUksRUFDSixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2hCLGVBQWUsRUFDaEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRyxPQUFPLEVBQUUsNEJBQTRCLEVBQXlCLE1BQU0sMkJBQTJCLENBQUM7QUFDaEcsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDL0UsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0UsT0FBTyxFQUFxQix5QkFBeUIsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEYsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBTyxNQUFNLGdCQUFnQixDQUFDO0FBQ25HLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBTzlELElBQWEsc0JBQXNCLEdBQW5DLE1BQWEsc0JBQXNCO0lBaUJqQyxZQUNVLEdBQXFCLEVBQ3JCLFFBQWtDLEVBQ2xDLElBQWdCLEVBQ21CLE1BQXlCLEVBQ3ZDLFlBQVksRUFDckIsd0JBQXFELEVBQ3JELElBQXlCLEVBQ2pCLFNBQW9CLEVB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QkFBN0QsUUFBUSxZQUFJLElBQUk7O0FBekJLO0lBQXZCLEtBQUssQ0FBQyxlQUFlLENBQUM7NERBQThCO0FBQzVDO0lBQVIsS0FBSyxFQUFFO2tFQUF3QztBQUN2QztJQUFSLEtBQUssRUFBRTtnRUFBZ0Q7QUFDL0M7SUFBUixLQUFLLEVBQUU7b0VBQTZCO0FBQzVCO0lBQVIsS0FBSyxFQUFFO21FQUE0QjtBQUMzQjtJQUFSLEtBQUssRUFBRTtrRUFBaUQ7QUFOOUMsc0JBQXNCO0lBSmxDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFDTiw4UEFBOFA7S0FDalEsQ0FBQztJQXNCRyxXQUFBLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO0lBQ2pDLFdBQUEsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQ25CLFdBQUEsUUFBUSxFQUFFLENBQUE7SUFDVixXQUFBLFFBQVEsRUFBRSxDQUFBO0lBQ1YsV0FBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsSUFBSSxFQUFFLENBQUE7SUFDbEIsV0FBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsSUFBSSxFQUFFLENBQUE7R0ExQlYsc0JBQXNCLENBd0psQztTQXhKWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIENvbXBvbmVudFJlZixcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBJbmplY3QsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3B0aW9uYWwsXG4gIFNlbGYsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBFbWJlZGRlZFZpZXdSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIENvbnRyb2xDb250YWluZXIsIE5nQ29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IERlZmF1bHRDb250cm9sRXJyb3JDb21wb25lbnQsIENvbnRyb2xFcnJvckNvbXBvbmVudCB9IGZyb20gJy4vY29udHJvbC1lcnJvci5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ29udHJvbEVycm9yQW5jaG9yRGlyZWN0aXZlIH0gZnJvbSAnLi9jb250cm9sLWVycm9yLWFuY2hvci5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgRU1QVFksIGZyb21FdmVudCwgbWVyZ2UsIE5FVkVSLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBFcnJvclRhaWxvckNvbmZpZywgRXJyb3JUYWlsb3JDb25maWdQcm92aWRlciwgRk9STV9FUlJPUlMgfSBmcm9tICcuL3Byb3ZpZGVycyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwVG8sIHN0YXJ0V2l0aCwgc3dpdGNoTWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZvcm1BY3Rpb25EaXJlY3RpdmUgfSBmcm9tICcuL2Zvcm0tYWN0aW9uLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBFcnJvcnNNYXAgfSBmcm9tICcuL3R5cGVzJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOlxuICAgICdbZm9ybUNvbnRyb2xOYW1lXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1Db250cm9sXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1Hcm91cF06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSksIFtmb3JtR3JvdXBOYW1lXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1BcnJheU5hbWVdOm5vdChbY29udHJvbEVycm9yc0lnbm9yZV0pLCBbbmdNb2RlbF06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSknXG59KVxuZXhwb3J0IGNsYXNzIENvbnRyb2xFcnJvcnNEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgnY29udHJvbEVycm9ycycpIGN1c3RvbUVycm9yczogRXJyb3JzTWFwID0ge307XG4gIEBJbnB1dCgpIGNvbnRyb2xFcnJvcnNDbGFzczogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBASW5wdXQoKSBjb250cm9sRXJyb3JzVHBsOiBUZW1wbGF0ZVJlZjxhbnk+IHwgdW5kZWZpbmVkO1xuICBASW5wdXQoKSBjb250cm9sRXJyb3JzT25Bc3luYyA9IHRydWU7XG4gIEBJbnB1dCgpIGNvbnRyb2xFcnJvcnNPbkJsdXIgPSB0cnVlO1xuICBASW5wdXQoKSBjb250cm9sRXJyb3JBbmNob3I6IENvbnRyb2xFcnJvckFuY2hvckRpcmVjdGl2ZTtcblxuICBwcml2YXRlIHJlZjogQ29tcG9uZW50UmVmPENvbnRyb2xFcnJvckNvbXBvbmVudD47XG4gIHByaXZhdGUgYW5jaG9yOiBWaWV3Q29udGFpbmVyUmVmO1xuICBwcml2YXRlIHN1Ym1pdCQ6IE9ic2VydmFibGU8RXZlbnQ+O1xuICBwcml2YXRlIHJlc2V0JDogT2JzZXJ2YWJsZTxFdmVudD47XG4gIHByaXZhdGUgY29udHJvbDogQWJzdHJhY3RDb250cm9sO1xuICBwcml2YXRlIGRlc3Ryb3kgPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIG1lcmdlZENvbmZpZzogRXJyb3JUYWlsb3JDb25maWcgPSB7fTtcbiAgcHJpdmF0ZSBjdXN0b21BbmNob3JEZXN0cm95Rm46ICgpID0+IHZvaWQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB2Y3I6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgaG9zdDogRWxlbWVudFJlZixcbiAgICBASW5qZWN0KEVycm9yVGFpbG9yQ29uZmlnUHJvdmlkZXIpIHByaXZhdGUgY29uZmlnOiBFcnJvclRhaWxvckNvbmZpZyxcbiAgICBASW5qZWN0KEZPUk1fRVJST1JTKSBwcml2YXRlIGdsb2JhbEVycm9ycyxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGNvbnRyb2xFcnJvckFuY2hvclBhcmVudDogQ29udHJvbEVycm9yQW5jaG9yRGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZm9ybTogRm9ybUFjdGlvbkRpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKSBAU2VsZigpIHByaXZhdGUgbmdDb250cm9sOiBOZ0NvbnRyb2wsXG4gICAgQE9wdGlvbmFsKCkgQFNlbGYoKSBwcml2YXRlIGNvbnRyb2xDb250YWluZXI6IENvbnRyb2xDb250YWluZXJcbiAgKSB7XG4gICAgdGhpcy5zdWJtaXQkID0gdGhpcy5mb3JtID8gdGhpcy5mb3JtLnN1Ym1pdCQgOiBFTVBUWTtcbiAgICB0aGlzLnJlc2V0JCA9IHRoaXMuZm9ybSA/IHRoaXMuZm9ybS5yZXNldCQgOiBFTVBUWTtcbiAgICB0aGlzLm1lcmdlZENvbmZpZyA9IHRoaXMuYnVpbGRDb25maWcoKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuYW5jaG9yID0gdGhpcy5yZXNvbHZlQW5jaG9yKCk7XG4gICAgdGhpcy5jb250cm9sID0gKHRoaXMuY29udHJvbENvbnRhaW5lciB8fCB0aGlzLm5nQ29udHJvbCkuY29udHJvbDtcbiAgICBjb25zdCBoYXNBc3luY1ZhbGlkYXRvciA9ICEhdGhpcy5jb250cm9sLmFzeW5jVmFsaWRhdG9yO1xuICAgIGNvbnN0IGlzSW5wdXQgPSB0aGlzLm1lcmdlZENvbmZpZy5ibHVyUHJlZGljYXRlKHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50KTtcblxuICAgIGNvbnN0IHN0YXR1c0NoYW5nZXMkID0gdGhpcy5jb250cm9sLnN0YXR1c0NoYW5nZXMucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcbiAgICBjb25zdCB2YWx1ZUNoYW5nZXMkID0gdGhpcy5jb250cm9sLnZhbHVlQ2hhbmdlcztcbiAgICBjb25zdCBjb250cm9sQ2hhbmdlcyQgPSBtZXJnZShzdGF0dXNDaGFuZ2VzJCwgdmFsdWVDaGFuZ2VzJCk7XG4gICAgbGV0IGNoYW5nZXNPbkFzeW5jJDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XG4gICAgbGV0IGNoYW5nZXNPbkJsdXIkOiBPYnNlcnZhYmxlPGFueT4gPSBFTVBUWTtcblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvcnNPbkFzeW5jICYmIGhhc0FzeW5jVmFsaWRhdG9yKSB7XG4gICAgICAvLyBoYXNBc3luY1RoZW5VcG9uU3RhdHVzQ2hhbmdlXG4gICAgICBjaGFuZ2VzT25Bc3luYyQgPSBzdGF0dXNDaGFuZ2VzJC5waXBlKHN0YXJ0V2l0aCh0cnVlKSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yc09uQmx1ciAmJiBpc0lucHV0KSB7XG4gICAgICBjb25zdCBibHVyJCA9IGZyb21FdmVudCh0aGlzLmhvc3QubmF0aXZlRWxlbWVudCwgJ2ZvY3Vzb3V0Jyk7XG4gICAgICAvLyBibHVyRmlyc3RUaGVuVXBvbkNoYW5nZVxuICAgICAgY2hhbmdlc09uQmx1ciQgPSBibHVyJC5waXBlKHN3aXRjaE1hcCgoKSA9PiB2YWx1ZUNoYW5nZXMkLnBpcGUoc3RhcnRXaXRoKHRydWUpKSkpO1xuICAgIH1cblxuICAgIGNvbnN0IHN1Ym1pdCQgPSBtZXJnZSh0aGlzLnN1Ym1pdCQucGlwZShtYXBUbyh0cnVlKSksIHRoaXMucmVzZXQkLnBpcGUobWFwVG8oZmFsc2UpKSk7XG5cbiAgICAvLyB3aGVuIHN1Ym1pdHRlZCwgc3VibWl0Rmlyc3RUaGVuVXBvbkNoYW5nZXNcbiAgICBjb25zdCBjaGFuZ2VzT25TdWJtaXQkID0gc3VibWl0JC5waXBlKFxuICAgICAgc3dpdGNoTWFwKHN1Ym1pdCA9PiAoc3VibWl0ID8gY29udHJvbENoYW5nZXMkLnBpcGUoc3RhcnRXaXRoKHRydWUpKSA6IE5FVkVSKSlcbiAgICApO1xuXG4gICAgLy8gb24gcmVzZXQsIGNsZWFyIENvbXBvbmVudFJlZiBhbmQgY3VzdG9tQW5jaG9yRGVzdHJveUZuXG4gICAgdGhpcy5yZXNldCQucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95KSkuc3Vic2NyaWJlKCgpID0+IHRoaXMuY2xlYXJSZWZzKCkpO1xuXG4gICAgbWVyZ2UoY2hhbmdlc09uQXN5bmMkLCBjaGFuZ2VzT25CbHVyJCwgY2hhbmdlc09uU3VibWl0JClcbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnZhbHVlQ2hhbmdlcygpKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0RXJyb3IodGV4dDogc3RyaW5nLCBlcnJvcj86IFZhbGlkYXRpb25FcnJvcnMpIHtcbiAgICBpZiAoIXRoaXMucmVmKSB7XG4gICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeTxDb250cm9sRXJyb3JDb21wb25lbnQ+KFxuICAgICAgICB0aGlzLm1lcmdlZENvbmZpZy5jb250cm9sRXJyb3JDb21wb25lbnRcbiAgICAgICk7XG4gICAgICB0aGlzLnJlZiA9IHRoaXMuYW5jaG9yLmNyZWF0ZUNvbXBvbmVudDxDb250cm9sRXJyb3JDb21wb25lbnQ+KGZhY3RvcnkpO1xuICAgIH1cbiAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMucmVmLmluc3RhbmNlO1xuXG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yc1RwbCkge1xuICAgICAgaW5zdGFuY2UuY3JlYXRlVGVtcGxhdGUodGhpcy5jb250cm9sRXJyb3JzVHBsLCBlcnJvciwgdGV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluc3RhbmNlLnRleHQgPSB0ZXh0O1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcykge1xuICAgICAgaW5zdGFuY2UuY3VzdG9tQ2xhc3MgPSB0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcztcbiAgICB9XG5cbiAgICBpZiAodGhpcy5tZXJnZWRDb25maWcuY29udHJvbEVycm9yQ29tcG9uZW50QW5jaG9yRm4pIHtcbiAgICAgIHRoaXMuY3VzdG9tQW5jaG9yRGVzdHJveUZuID0gdGhpcy5tZXJnZWRDb25maWcuY29udHJvbEVycm9yQ29tcG9uZW50QW5jaG9yRm4oXG4gICAgICAgIHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50IGFzIEhUTUxFbGVtZW50LFxuICAgICAgICAodGhpcy5yZWYuaG9zdFZpZXcgYXMgRW1iZWRkZWRWaWV3UmVmPGFueT4pLnJvb3ROb2Rlc1swXSBhcyBIVE1MRWxlbWVudFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3kubmV4dCgpO1xuICAgIHRoaXMuY2xlYXJSZWZzKCk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFyUmVmcygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jdXN0b21BbmNob3JEZXN0cm95Rm4pIHtcbiAgICAgIHRoaXMuY3VzdG9tQW5jaG9yRGVzdHJveUZuKCk7XG4gICAgICB0aGlzLmN1c3RvbUFuY2hvckRlc3Ryb3lGbiA9IG51bGw7XG4gICAgfVxuICAgIGlmICh0aGlzLnJlZikge1xuICAgICAgdGhpcy5yZWYuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLnJlZiA9IG51bGw7XG4gIH1cblxuICBwcml2YXRlIHZhbHVlQ2hhbmdlcygpIHtcbiAgICBjb25zdCBjb250cm9sRXJyb3JzID0gdGhpcy5jb250cm9sLmVycm9ycztcbiAgICBpZiAoY29udHJvbEVycm9ycykge1xuICAgICAgY29uc3QgW2ZpcnN0S2V5XSA9IE9iamVjdC5rZXlzKGNvbnRyb2xFcnJvcnMpO1xuICAgICAgY29uc3QgZ2V0RXJyb3IgPSB0aGlzLmN1c3RvbUVycm9yc1tmaXJzdEtleV0gfHwgdGhpcy5nbG9iYWxFcnJvcnNbZmlyc3RLZXldO1xuICAgICAgaWYgKCFnZXRFcnJvcikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRleHQgPSB0eXBlb2YgZ2V0RXJyb3IgPT09ICdmdW5jdGlvbicgPyBnZXRFcnJvcihjb250cm9sRXJyb3JzW2ZpcnN0S2V5XSkgOiBnZXRFcnJvcjtcbiAgICAgIHRoaXMuc2V0RXJyb3IodGV4dCwgY29udHJvbEVycm9ycyk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnJlZikge1xuICAgICAgdGhpcy5zZXRFcnJvcihudWxsKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlc29sdmVBbmNob3IoKSB7XG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yQW5jaG9yKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb250cm9sRXJyb3JBbmNob3IudmNyO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvckFuY2hvclBhcmVudCkge1xuICAgICAgcmV0dXJuIHRoaXMuY29udHJvbEVycm9yQW5jaG9yUGFyZW50LnZjcjtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmNyO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENvbmZpZygpOiBFcnJvclRhaWxvckNvbmZpZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLntcbiAgICAgICAgYmx1clByZWRpY2F0ZShlbGVtZW50KSB7XG4gICAgICAgICAgcmV0dXJuIGVsZW1lbnQudGFnTmFtZSA9PT0gJ0lOUFVUJyB8fCBlbGVtZW50LnRhZ05hbWUgPT09ICdTRUxFQ1QnO1xuICAgICAgICB9LFxuICAgICAgICBjb250cm9sRXJyb3JDb21wb25lbnQ6IERlZmF1bHRDb250cm9sRXJyb3JDb21wb25lbnRcbiAgICAgIH0sXG4gICAgICAuLi50aGlzLmNvbmZpZ1xuICAgIH07XG4gIH1cbn1cbiJdfQ==